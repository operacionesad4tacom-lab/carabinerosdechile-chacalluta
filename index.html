<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SICOF - Carabineros de Chile</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/mobile.css">
    <link rel="stylesheet" href="css/tablet.css">
    <link rel="stylesheet" href="css/desktop.css">
    <link rel="icon" href="assets/logos/favicon.ico">
    <style>
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #e6f2ec 100%);
            padding: var(--spacing-md);
        }
        
        .login-card {
            width: 100%;
            max-width: 450px;
            background: var(--blanco);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            border-top: 6px solid var(--verde-oficial);
        }
        
        .login-header {
            text-align: center;
            padding: var(--spacing-xl);
            background: linear-gradient(to right, var(--verde-oscuro), var(--verde-oficial));
            color: var(--blanco);
        }
        
        .login-logo {
            height: 80px;
            margin-bottom: var(--spacing-md);
        }
        
        .login-body {
            padding: var(--spacing-xl);
        }
        
        .login-footer {
            text-align: center;
            padding: var(--spacing-md);
            background-color: var(--gris-claro);
            color: var(--gris-medio);
            font-size: 0.875rem;
            border-top: 1px solid var(--verde-claro);
        }
        
        .info-box {
            margin-top: var(--spacing-lg);
            padding: var(--spacing-md);
            background: var(--verde-claro);
            border-radius: var(--border-radius-sm);
            border-left: 4px solid var(--verde-oficial);
        }
        
        .info-box h4 {
            color: var(--verde-oscuro);
            margin-bottom: var(--spacing-sm);
            font-size: 0.875rem;
        }
        
        .info-box p {
            font-size: 0.8rem;
            color: var(--gris-profesional);
            margin: 4px 0;
        }
        
        .info-box .password-hint {
            background: var(--blanco);
            padding: var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            margin-top: var(--spacing-sm);
            font-family: monospace;
            font-weight: 600;
            color: var(--verde-oficial);
            text-align: center;
        }
        
        .alert {
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--verde-claro);
            border-top-color: var(--blanco);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .user-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: var(--spacing-sm);
        }
        
        .user-item {
            padding: var(--spacing-xs);
            font-size: 0.75rem;
            color: var(--gris-medio);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .user-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <img src="assets/logos/escudo-carabineros.png" alt="Carabineros de Chile" class="login-logo">
                <h1 style="margin-bottom: var(--spacing-xs);">CARABINEROS DE CHILE</h1>
                <p style="opacity: 0.9; font-size: 0.875rem;">Sistema Integrado de Control Fronterizo</p>
                <p style="opacity: 0.8; font-size: 0.75rem; margin-top: var(--spacing-xs);">
                    Especialidad Monta√±a y Fronteras
                </p>
            </div>
            
            <div class="login-body">
                <!-- Mensaje de error/success -->
                <div id="loginMessage" class="alert" style="display: none;"></div>
                
                <form id="loginForm">
                    <div class="form-group">
                        <label for="email" class="form-label">
                            üìß Correo Institucional
                        </label>
                        <input 
                            type="email" 
                            id="email" 
                            class="form-control" 
                            placeholder="usuario@carabineros.cl"
                            required
                            autocomplete="username"
                            list="emailSuggestions"
                        >
                        <datalist id="emailSuggestions">
                            <option value="digitador.chacalluta@carabineros.cl">
                            <option value="jefe.chacalluta@carabineros.cl">
                            <option value="jefatura@carabineros.cl">
                            <option value="admin@carabineros.cl">
                        </datalist>
                    </div>
                    
                    <div class="form-group">
                        <label for="password" class="form-label">
                            üîí Contrase√±a
                        </label>
                        <input 
                            type="password" 
                            id="password" 
                            class="form-control" 
                            placeholder="Contrase√±a gen√©rica del sistema"
                            required
                            autocomplete="current-password"
                        >
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <span id="loginText">üö™ INGRESAR AL SISTEMA</span>
                        <span id="loginLoading" style="display: none; align-items: center; justify-content: center;">
                            <div class="loading-spinner" style="margin-right: 8px;"></div>
                            Verificando...
                        </span>
                    </button>
                </form>
                
                <!-- Informaci√≥n de acceso -->
                <div class="info-box">
                    <h4>üîë Informaci√≥n de Acceso</h4>
                    <p><strong>Contrase√±a para todos los usuarios:</strong></p>
                    <div class="password-hint">Monta√±aofrontera2026</div>
                    
                    <details style="margin-top: var(--spacing-md);">
                        <summary style="cursor: pointer; font-weight: 600; color: var(--verde-oscuro); font-size: 0.875rem;">
                            Ver usuarios disponibles ‚ñº
                        </summary>
                        <div class="user-list" style="margin-top: var(--spacing-sm);">
                            <div class="user-item"><strong>Digitadores:</strong></div>
                            <div class="user-item">‚Ä¢ digitador.chacalluta@carabineros.cl</div>
                            <div class="user-item">‚Ä¢ digitador.visviri@carabineros.cl</div>
                            <div class="user-item">‚Ä¢ digitador.chungara@carabineros.cl</div>
                            <div class="user-item">‚Ä¢ digitador.alcerreca@carabineros.cl</div>
                            <div class="user-item">‚Ä¢ digitador.tacora@carabineros.cl</div>
                            
                            <div class="user-item" style="margin-top: var(--spacing-sm);"><strong>Jefes de Destacamento:</strong></div>
                            <div class="user-item">‚Ä¢ jefe.chacalluta@carabineros.cl</div>
                            <div class="user-item">‚Ä¢ jefe.visviri@carabineros.cl</div>
                            <div class="user-item">‚Ä¢ jefe.chungara@carabineros.cl</div>
                            <div class="user-item">‚Ä¢ jefe.alcerreca@carabineros.cl</div>
                            <div class="user-item">‚Ä¢ jefe.tacora@carabineros.cl</div>
                            
                            <div class="user-item" style="margin-top: var(--spacing-sm);"><strong>Jefatura:</strong></div>
                            <div class="user-item">‚Ä¢ jefatura@carabineros.cl</div>
                            <div class="user-item">‚Ä¢ jefatura.montana@carabineros.cl</div>
                            
                            <div class="user-item" style="margin-top: var(--spacing-sm);"><strong>Administradores:</strong></div>
                            <div class="user-item">‚Ä¢ admin@carabineros.cl</div>
                            <div class="user-item">‚Ä¢ admin.sistema@carabineros.cl</div>
                        </div>
                    </details>
                </div>
            </div>
            
            <div class="login-footer">
                <p>¬© 2026 Carabineros de Chile. Todos los derechos reservados.</p>
                <p style="font-size: 0.75rem; margin-top: 4px;">SICOF v2.0 - Autenticaci√≥n Local</p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script>
        // ============================================
        // MANEJADOR DE LOGIN
        // Autenticaci√≥n local sin base de datos
        // ============================================
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const loginBtn = e.target.querySelector('button[type="submit"]');
            const loginText = document.getElementById('loginText');
            const loginLoading = document.getElementById('loginLoading');
            const messageEl = document.getElementById('loginMessage');
            
            // Mostrar loading
            loginText.style.display = 'none';
            loginLoading.style.display = 'flex';
            loginBtn.disabled = true;
            
            // Ocultar mensaje anterior
            messageEl.style.display = 'none';
            
            // Simular delay de red (para mejor UX)
            setTimeout(() => {
                try {
                    // Llamar a la funci√≥n de login local
                    const usuario = window.loginUsuario(email, password);
                    
                    // Guardar informaci√≥n en localStorage
                    localStorage.setItem('sicof_user', JSON.stringify(usuario));
                    
                    // Mostrar mensaje de √©xito
                    messageEl.innerHTML = `
                        <strong>‚úÖ Bienvenido ${usuario.nombre}</strong>
                        <p>Ingresando al sistema...</p>
                    `;
                    messageEl.className = 'alert alert-success';
                    messageEl.style.display = 'block';
                    
                    // Redirigir seg√∫n rol
                    setTimeout(() => {
                        const redirectUrl = window.SICOF_CONFIG.redirectUrls[usuario.rol];
                        if (redirectUrl) {
                            window.location.href = redirectUrl;
                        } else {
                            throw new Error('Rol no v√°lido');
                        }
                    }, 800);
                    
                } catch (error) {
                    // Mostrar error
                    let errorMessage = error.message;
                    let helpText = '';
                    
                    if (error.message.includes('Contrase√±a')) {
                        helpText = 'La contrase√±a correcta es: <strong>Monta√±aofrontera2026</strong>';
                    } else if (error.message.includes('no registrado')) {
                        helpText = 'Verifica que el correo est√© en la lista de usuarios disponibles.';
                    }
                    
                    messageEl.innerHTML = `
                        <strong>‚ùå Error de autenticaci√≥n</strong>
                        <p>${errorMessage}</p>
                        ${helpText ? `<p style="font-size: 0.875rem; margin-top: 8px;">${helpText}</p>` : ''}
                    `;
                    messageEl.className = 'alert alert-danger';
                    messageEl.style.display = 'block';
                    
                    // Restaurar bot√≥n
                    loginText.style.display = 'inline';
                    loginLoading.style.display = 'none';
                    loginBtn.disabled = false;
                    
                    // Auto-ocultar mensaje despu√©s de 8 segundos
                    setTimeout(() => {
                        messageEl.style.display = 'none';
                    }, 8000);
                }
            }, 500);
        });
        
        // Auto-focus en email al cargar
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('email').focus();
            
            // Verificar si ya hay sesi√≥n activa
            const user = window.verificarSesion();
            if (user) {
                // Ya est√° logueado, redirigir
                const redirectUrl = window.SICOF_CONFIG.redirectUrls[user.rol];
                if (redirectUrl) {
                    window.location.href = redirectUrl;
                }
            }
        });
        
        // Autocompletar email al seleccionar de la lista
        document.getElementById('email').addEventListener('input', function() {
            // Si el email est√° completo, hacer focus en password
            if (this.value.includes('@carabineros.cl')) {
                setTimeout(() => {
                    document.getElementById('password').focus();
                }, 100);
            }
        });
    </script>
</body>
</html>
